# Flash OAuth2 E2E æµ‹è¯•æŒ‡å—

æœ¬æŒ‡å—è¯¦ç»†è¯´æ˜å¦‚ä½•è¿è¡Œ Flash OAuth2 æœåŠ¡å™¨çš„ç«¯åˆ°ç«¯ï¼ˆE2Eï¼‰æµ‹è¯•å¥—ä»¶ã€‚

## ğŸ“‹ æ¦‚è¿°

E2E æµ‹è¯•å¥—ä»¶æä¾›äº†å¯¹ OAuth2 æœåŠ¡å™¨çš„å…¨é¢æµ‹è¯•ï¼ŒåŒ…æ‹¬ï¼š

- **OAuth2 æˆæƒç æµç¨‹æµ‹è¯•** - å®Œæ•´çš„æˆæƒæµç¨‹éªŒè¯
- **æ‰‹æœºå·éªŒè¯æµç¨‹æµ‹è¯•** - çŸ­ä¿¡éªŒè¯ç ç™»å½•æµç¨‹
- **API ç«¯ç‚¹æµ‹è¯•** - æ‰€æœ‰ REST API ç«¯ç‚¹çš„åŠŸèƒ½æµ‹è¯•
- **JWKS ç«¯ç‚¹æµ‹è¯•** - JWT å¯†é’¥é›†éªŒè¯
- **å®‰å…¨åŠŸèƒ½æµ‹è¯•** - å®‰å…¨æ¼æ´å’Œè¾¹ç•Œæƒ…å†µæµ‹è¯•
- **æ•°æ®åº“é›†æˆæµ‹è¯•** - PostgreSQL æ“ä½œéªŒè¯
- **Redis é›†æˆæµ‹è¯•** - ç¼“å­˜å’Œä¼šè¯å­˜å‚¨æµ‹è¯•
- **æ€§èƒ½åŸºå‡†æµ‹è¯•** - æ€§èƒ½æŒ‡æ ‡å’Œè´Ÿè½½æµ‹è¯•

## ğŸ”§ ç¯å¢ƒè¦æ±‚

### å¿…éœ€æœåŠ¡

åœ¨è¿è¡Œ E2E æµ‹è¯•ä¹‹å‰ï¼Œè¯·ç¡®ä¿ä»¥ä¸‹æœåŠ¡æ­£åœ¨è¿è¡Œï¼š

1. **PostgreSQL** (ç«¯å£ 5432)

   ```bash
   # macOS (ä½¿ç”¨Homebrew)
   brew services start postgresql

   # Ubuntu/Debian
   sudo systemctl start postgresql

   # Docker
   docker run --name postgres -e POSTGRES_PASSWORD=1q2w3e4r -p 5432:5432 -d postgres
   ```

2. **Redis** (ç«¯å£ 6379)

   ```bash
   # macOS (ä½¿ç”¨Homebrew)
   brew services start redis

   # Ubuntu/Debian
   sudo systemctl start redis

   # Docker
   docker run --name redis -p 6379:6379 -d redis
   ```

### ä¾èµ–åŒ…

ç¡®ä¿å®‰è£…äº†æµ‹è¯•ä¾èµ–ï¼š

```bash
make test-e2e-deps
# æˆ–è€…
go get github.com/stretchr/testify@latest
go mod tidy
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆåŒ…æ‹¬è®¾ç½®ã€æµ‹è¯•ã€åŸºå‡†æµ‹è¯•å’Œè¦†ç›–ç‡æŠ¥å‘Šï¼‰
make test-e2e-all
```

### è¿è¡ŒåŸºæœ¬æµ‹è¯•

```bash
# ä»…è¿è¡Œæµ‹è¯•ï¼ˆå‡è®¾ç¯å¢ƒå·²è®¾ç½®ï¼‰
make test-e2e-run

# å¿«é€Ÿæµ‹è¯•ï¼ˆæ— ç¯å¢ƒè®¾ç½®/æ¸…ç†ï¼‰
make test-e2e-quick
```

## ğŸ“Š æµ‹è¯•å‘½ä»¤è¯¦è§£

### åŸºæœ¬æµ‹è¯•å‘½ä»¤

| å‘½ä»¤                    | æè¿°          | ç”¨é€”                       |
| ----------------------- | ------------- | -------------------------- |
| `make test-e2e-setup`   | è®¾ç½®æµ‹è¯•ç¯å¢ƒ  | åˆ›å»ºæµ‹è¯•æ•°æ®åº“ï¼Œæ¸…ç† Redis |
| `make test-e2e-run`     | è¿è¡Œ E2E æµ‹è¯• | æ‰§è¡Œæ‰€æœ‰åŠŸèƒ½æµ‹è¯•           |
| `make test-e2e-quick`   | å¿«é€Ÿæµ‹è¯•      | æ— ç¯å¢ƒè®¾ç½®çš„å¿«é€Ÿæµ‹è¯•       |
| `make test-e2e-cleanup` | æ¸…ç†æµ‹è¯•èµ„æº  | åˆ é™¤æµ‹è¯•æ•°æ®åº“å’Œç¼“å­˜       |

### é«˜çº§æµ‹è¯•å‘½ä»¤

| å‘½ä»¤                                   | æè¿°           | ç¤ºä¾‹                                                 |
| -------------------------------------- | -------------- | ---------------------------------------------------- |
| `make test-e2e-specific TEST=<æµ‹è¯•å>` | è¿è¡Œç‰¹å®šæµ‹è¯•   | `make test-e2e-specific TEST=TestCompleteOAuth2Flow` |
| `make test-e2e-bench`                  | æ€§èƒ½åŸºå‡†æµ‹è¯•   | æµ‹è¯• token ç”Ÿæˆå’Œç”¨æˆ·ä¿¡æ¯æ£€ç´¢æ€§èƒ½                    |
| `make test-e2e-coverage`               | ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š | ç”Ÿæˆ HTML è¦†ç›–ç‡æŠ¥å‘Š                                 |
| `make test-e2e-race`                   | ç«æ€æ¡ä»¶æ£€æµ‹   | æ£€æµ‹å¹¶å‘å®‰å…¨é—®é¢˜                                     |

### å¼€å‘å·¥å…·å‘½ä»¤

| å‘½ä»¤                          | æè¿°           | ç”¨é€”                         |
| ----------------------------- | -------------- | ---------------------------- |
| `make test-e2e-validate`      | éªŒè¯æµ‹è¯•æ–‡ä»¶   | æ£€æŸ¥è¯­æ³•å’Œæ ¼å¼               |
| `make test-e2e-view-coverage` | æŸ¥çœ‹è¦†ç›–ç‡æŠ¥å‘Š | åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ coverage.html |

## ğŸ“ æµ‹è¯•é…ç½®

### ç¯å¢ƒå˜é‡

æµ‹è¯•ä½¿ç”¨ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
TEST_DATABASE_URL="postgres://postgres:1q2w3e4r@localhost:5432/oauth2_test?sslmode=disable"

# æµ‹è¯•Redisè¿æ¥
TEST_REDIS_URL="redis://localhost:6379/15"

# æµ‹è¯•æœåŠ¡ç«¯å£
TEST_PORT="8081"

# Ginè¿è¡Œæ¨¡å¼
GIN_MODE="test"

# JWTå¯†é’¥ï¼ˆæµ‹è¯•ç”¨ï¼‰
JWT_SECRET="test-jwt-secret-key-for-oauth2-server"
```

### æ•°æ®åº“é…ç½®

æµ‹è¯•ä¼šè‡ªåŠ¨åˆ›å»ºå’Œç®¡ç†æµ‹è¯•æ•°æ®åº“ï¼š

- æ•°æ®åº“åï¼š`oauth2_test`
- Redis æ•°æ®åº“ï¼š`15`ï¼ˆé¿å…ä¸ä¸»åº”ç”¨å†²çªï¼‰

## ğŸ§ª æµ‹è¯•å¥—ä»¶è¯¦æƒ…

### 1. OAuth2 æˆæƒæµç¨‹æµ‹è¯•

**æ–‡ä»¶**: `tests/e2e_oauth2_test.go`

- `TestCompleteOAuth2Flow` - å®Œæ•´æˆæƒç æµç¨‹
- `TestPhoneAuthenticationFlow` - æ‰‹æœºå·éªŒè¯æµç¨‹
- `TestJWKSEndpoint` - JWKS ç«¯ç‚¹æµ‹è¯•
- `TestHealthEndpoint` - å¥åº·æ£€æŸ¥ç«¯ç‚¹
- `TestDocumentationEndpoint` - æ–‡æ¡£ç«¯ç‚¹æµ‹è¯•

**è¿è¡Œç¤ºä¾‹**:

```bash
make test-e2e-specific TEST=TestCompleteOAuth2Flow
```

### 2. API ç«¯ç‚¹æµ‹è¯•

**æ–‡ä»¶**: `tests/e2e_api_test.go`

- `TestAPIEndpoints` - æ‰€æœ‰ API ç«¯ç‚¹åŠŸèƒ½æµ‹è¯•
- `TestErrorHandling` - é”™è¯¯å¤„ç†æµ‹è¯•
- `TestSecurityFeatures` - å®‰å…¨åŠŸèƒ½æµ‹è¯•
- `TestDatabaseIntegration` - æ•°æ®åº“é›†æˆæµ‹è¯•
- `TestRedisIntegration` - Redis é›†æˆæµ‹è¯•
- `TestEdgeCases` - è¾¹ç•Œæƒ…å†µæµ‹è¯•

### 3. æ€§èƒ½åŸºå‡†æµ‹è¯•

**æµ‹è¯•é¡¹ç›®**:

- Token ç”Ÿæˆæ€§èƒ½
- ç”¨æˆ·ä¿¡æ¯æ£€ç´¢æ€§èƒ½
- å¹¶å‘è¯·æ±‚å¤„ç†èƒ½åŠ›

**è¿è¡Œç¤ºä¾‹**:

```bash
make test-e2e-bench
```

## ğŸ“Š æµ‹è¯•æŠ¥å‘Š

### è¦†ç›–ç‡æŠ¥å‘Š

ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Šï¼š

```bash
make test-e2e-coverage
```

è¿™ä¼šç”Ÿæˆï¼š

- `coverage.out` - è¦†ç›–ç‡æ•°æ®æ–‡ä»¶
- `coverage.html` - HTML æ ¼å¼çš„è¦†ç›–ç‡æŠ¥å‘Š

æŸ¥çœ‹æŠ¥å‘Šï¼š

```bash
make test-e2e-view-coverage
```

### æ€§èƒ½æŠ¥å‘Š

åŸºå‡†æµ‹è¯•ä¼šè¾“å‡ºæ€§èƒ½æŒ‡æ ‡ï¼š

- æ“ä½œæ‰§è¡Œæ—¶é—´
- å†…å­˜åˆ†é…ç»Ÿè®¡
- å¹¶å‘æ€§èƒ½æ•°æ®

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **PostgreSQL è¿æ¥å¤±è´¥**

   ```
   ç¡®ä¿PostgreSQLæœåŠ¡æ­£åœ¨è¿è¡Œ
   æ£€æŸ¥è¿æ¥å­—ç¬¦ä¸²ä¸­çš„å¯†ç æ˜¯å¦æ­£ç¡®
   éªŒè¯æ•°æ®åº“æœåŠ¡å™¨åœ°å€å’Œç«¯å£
   ```

2. **Redis è¿æ¥å¤±è´¥**

   ```
   ç¡®ä¿RedisæœåŠ¡æ­£åœ¨è¿è¡Œ
   æ£€æŸ¥Redisæ˜¯å¦ç›‘å¬åœ¨6379ç«¯å£
   éªŒè¯Redisé…ç½®å…è®¸æœ¬åœ°è¿æ¥
   ```

3. **ç«¯å£å†²çª**

   ```
   ç¡®ä¿æµ‹è¯•ç«¯å£8081æœªè¢«å ç”¨
   æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–OAuth2æœåŠ¡å®ä¾‹åœ¨è¿è¡Œ
   ```

4. **æƒé™é”™è¯¯**
   ```
   ç¡®ä¿æµ‹è¯•è„šæœ¬æœ‰æ‰§è¡Œæƒé™
   chmod +x tests/run_e2e_tests.sh
   ```

### è°ƒè¯•æ¨¡å¼

å¯ç”¨è¯¦ç»†æ—¥å¿—è¾“å‡ºï¼š

```bash
# è®¾ç½®è¯¦ç»†æ—¥å¿—çº§åˆ«
export LOG_LEVEL=debug

# è¿è¡Œæµ‹è¯•
make test-e2e-run
```

### æ¸…ç†ç¯å¢ƒ

å¦‚æœæµ‹è¯•ç¯å¢ƒå‡ºç°é—®é¢˜ï¼Œå®Œå…¨æ¸…ç†ï¼š

```bash
# åœæ­¢æ‰€æœ‰æœåŠ¡
make stop

# æ¸…ç†æµ‹è¯•èµ„æº
make test-e2e-cleanup

# é‡æ–°è®¾ç½®ç¯å¢ƒ
make test-e2e-setup
```

## ğŸš€ æŒç»­é›†æˆ

### GitHub Actions

å¯ä»¥åœ¨ CI/CD æµæ°´çº¿ä¸­é›†æˆ E2E æµ‹è¯•ï¼š

```yaml
- name: Run E2E Tests
  run: |
    make test-e2e-deps
    make test-e2e-all
```

### Docker æµ‹è¯•ç¯å¢ƒ

å¯¹äº CI ç¯å¢ƒï¼Œå¯ä»¥ä½¿ç”¨ Docker Compose å¯åŠ¨æµ‹è¯•ä¾èµ–ï¼š

```bash
# å¯åŠ¨æµ‹è¯•ä¾èµ–æœåŠ¡
docker-compose -f docker-compose.test.yml up -d

# è¿è¡Œæµ‹è¯•
make test-e2e-run

# æ¸…ç†
docker-compose -f docker-compose.test.yml down
```

## ğŸ“š æ›´å¤šä¿¡æ¯

- **é¡¹ç›®æ–‡æ¡£**: [README.md](../README.md)
- **API æ–‡æ¡£**: è¿è¡ŒæœåŠ¡å™¨åè®¿é—® `http://localhost:8080/docs`
- **æµ‹è¯•ä»£ç **: [tests/](./tests/) ç›®å½•
- **ä¸»è¦ä»£ç **: [ä¸»é¡¹ç›®ç›®å½•](../)

---

**æç¤º**: å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·ç¡®ä¿æ‰€æœ‰ä¾èµ–æœåŠ¡æ­£åœ¨è¿è¡Œï¼Œå¹¶ä¸”å·²å®‰è£…æ‰€æœ‰å¿…éœ€çš„ Go åŒ…ã€‚ä½¿ç”¨`make test-e2e-validate`æ£€æŸ¥æµ‹è¯•æ–‡ä»¶çš„è¯­æ³•é”™è¯¯ã€‚
